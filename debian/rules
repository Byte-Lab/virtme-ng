#!/usr/bin/make -f

export PYBUILD_NAME = virtme-ng
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export DEB_CFLAGS_MAINT_APPEND  = -Iinclude -D_FORTIFY_SOURCE=2
include /usr/share/dpkg/pkg-info.mk

include /usr/share/dpkg/architecture.mk
include /usr/share/dpkg/buildflags.mk
include /usr/share/rustc/architecture.mk
export CFLAGS CXXFLAGS CPPFLAGS LDFLAGS
export DEB_HOST_RUST_TYPE DEB_HOST_GNU_TYPE
export DEB_CARGO_CRATE=virtme-ng-init_0.0
export CARGO=/usr/share/cargo/bin/cargo
export CARGO_HOME=$(CURDIR)/debian/cargo_home
export DESTDIR=$(CARGO_HOME)/build

%:
	dh $@ --with python3 --buildsystem=pybuild

override_dh_auto_configure:
	mkdir -p $(CARGO_HOME)/registry
	$(CARGO) prepare-debian $(CARGO_HOME)/registry --link-from-system
	dh_auto_configure

override_dh_auto_build:
	cd virtme_ng_init; $(CARGO) install
	mkdir -p virtme/guest/bin/
	cp $(DESTDIR)/usr/bin/virtme-ng-init virtme/guest/bin/
	dh_auto_build

virtme-ng-prompt:
	(register-python-argcomplete virtme-ng vng || register-python-argcomplete3 virtme-ng vng) > $@

override_dh_install: virtme-ng-prompt
	dh_install

override_dh_clean:
	rm -rf virtme_ng.egg-info .pybuild
	rm -rf virtme-ng-prompt virtme/guest/bin/
	rm -rf virtme_ng/__pycache__/
	rm -rf $(CARGO_HOME) virtme_ng_init/.cargo/
	rm -rf virtme_ng_init/target/
	dh_clean
